# Code generated by dev-tool; DO NOT EDIT.
name: self-update
on:
  workflow_dispatch:

# Permissions for update
permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  dev-tool-self-update:
    if: startsWith(github.ref_name, 'dependabot/go_modules/github.com/flypay/go-kit-') == true
    runs-on: ubuntu-latest
    container:
      image: golang:1.22.0
    env:
      GOPRIVATE: github.com/flypay/*
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_BRANCH: ${{ github.ref_name }}
      GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      REPOSITORY: ${{ github.event.repository.name }}
    steps:
    - uses: actions/checkout@v4.1.0
    - name: Generate a token
      id: generate_token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.ASSETS_DOWNLOADER_APP_ID }}
        private-key: ${{ secrets.ASSETS_DOWNLOADER_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
    - uses: "./.github/actions/gh-client-install"
    - name: Upgrade
      env:
        GITHUB_ASSETS_DOWNLOADER_TOKEN: ${{ steps.generate_token.outputs.token }}
      run: |-
        # go-kit runs "git config remote.origin.url" which fails if this isn't set
        git config --global --add safe.directory '*'
        
        git config --global url."https://git:${GITHUB_ASSETS_DOWNLOADER_TOKEN}@github.com/flypay".insteadOf "https://github.com/flypay" || true

        UPDATE_VERSION=$(echo $GITHUB_BRANCH | sed 's/.*-\([0-9\.][0-9\.]*\).*/\1/')
        echo $UPDATE_VERSION
        export GITHUB_TOKEN=$GITHUB_ASSETS_DOWNLOADER_TOKEN
        gh release download v"${UPDATE_VERSION}" --pattern dev-tool-linux-amd64.tar.gz --repo flypay/go-kit --dir /tmp
        tar -xvf /tmp/dev-tool-linux-amd64.tar.gz -C /tmp
        mv /tmp/dev-tool /usr/local/bin/dev-tool
        go install github.com/securego/gosec/cmd/gosec@latest
        dev-tool update
    
        git config --global user.email "paul+automated@flypay.co.uk"
        git config --global user.name "flypay-automated-services"
        git add . && git commit -m "Updated service with newer dev-tool version" || echo "no changes to commit"
        git remote set-url origin https://github.com/$GITHUB_REPOSITORY_OWNER/$REPOSITORY.git
        git push --set-upstream origin $GITHUB_BRANCH
